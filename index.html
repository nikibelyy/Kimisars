<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Аварийный комиссар — Э-чек (Админ)</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg: rgba(250,250,253,0.85);
      --card: rgba(255,255,255,0.72);
      --border: rgba(0,0,0,0.08);
      --text: #0b0c0f;
      --muted:#6b7280;
      --tint:#007aff;
      --danger:#ff3b30;
      --radius: 20px;
      --blur: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --sf: -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Inter,system-ui,"Helvetica Neue",Arial,sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, monospace;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: rgba(16,16,18,.8);
        --card: rgba(28,28,30,.6);
        --border: rgba(255,255,255,0.08);
        --text:#f5f6f8;
        --muted:#a1a1aa;
        --shadow: 0 12px 28px rgba(0,0,0,.6);
      }
    }
    html,body{height:100%}
    body{
      margin:0; font: 15px/1.45 var(--sf); color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, #c7dafe33, transparent 60%),
        radial-gradient(1000px 700px at 110% 20%, #a7f3d033, transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
      -webkit-font-smoothing:antialiased; 
    }
    .container{max-width:980px; margin:24px auto; padding: 0 16px 80px}
    .navbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:12px;
      padding: 16px; margin-bottom: 12px;
      background: var(--bg); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
    }
    .app-title{ font-weight:700; font-size:20px; }
    .grid{display:grid; gap:16px; grid-template-columns: 1.2fr 1fr}
    @media (max-width: 900px){ .grid{grid-template-columns: 1fr} }
    .card{
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 16px; backdrop-filter: blur(var(--blur));
    }
    h3{margin-top:0}
    .row{display:grid; gap:12px; grid-template-columns: repeat(12, 1fr); align-items:end}
    .col-12{grid-column: span 12} .col-6{grid-column: span 6}
    label{font-size:12px; color:var(--muted)}
    input,select,textarea{
      width:100%; border:1px solid var(--border);
      background: rgba(255,255,255,.55); color:var(--text);
      padding:12px; border-radius:14px; outline:none;
    }
    .segmented{display:flex; padding:4px; border:1px solid var(--border); border-radius:14px; background:rgba(255,255,255,.4)}
    .segmented input{display:none}
    .segmented label{flex:1; padding:10px; text-align:center; cursor:pointer; border-radius:10px;}
    .segmented input:checked + label{ background: var(--tint); color:white }
    .btn{
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      background: var(--tint); color:white; border:none; border-radius: 14px;
      padding:12px 16px; font-weight:600; cursor:pointer;
    }
    .btn.secondary{ background: transparent; color: var(--tint); border:1px solid var(--tint) }
    .btn.ghost{ background: transparent; color: var(--text); border:1px solid var(--border) }
    .btn.danger{ background: var(--danger) }
    .table{width:100%; border-collapse:separate; border-spacing:0 10px}
    .table th{font-size:12px; color:var(--muted); text-align:left; padding:0 8px}
    .rowline{display:grid; grid-template-columns: 6fr 1fr 2fr 2fr auto; gap:8px; align-items:center; padding:8px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.5)}
    .receipt{background:white; color:#111; border:1px dashed #cbd5e1; border-radius:16px; padding:20px;}
    .hr{height:1px; background: repeating-linear-gradient(90deg, #cbd5e1 0 6px, transparent 6px 12px); margin:10px 0}
    .mono{font-family:var(--mono)}
    @media print{
      body{background:white}
      .navbar, .no-print{display:none !important}
      .grid{grid-template-columns: 1fr}
      @page{ size: A5 portrait; margin: 12mm }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="app-title">Аварийный комиссар · Э-чек</div>
  </div>

  <div class="container">
    <div class="grid">
      <div class="card">
        <h3>Данные для чека</h3>
        <div class="row">
          <div class="col-6"><label>Компания</label><input id="c_org"></div>
          <div class="col-6"><label>ИНН</label><input id="c_tax"></div>
          <div class="col-6"><label>Телефон</label><input id="c_phone"></div>
          <div class="col-6"><label>E-mail</label><input id="c_email"></div>
          <div class="col-12"><label>Адрес</label><input id="c_addr"></div>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div class="col-6"><label>Клиент</label><input id="cl_name"></div>
          <div class="col-6"><label>Телефон клиента</label><input id="cl_phone"></div>
          <div class="col-6"><label>Авто</label><input id="car"></div>
          <div class="col-6"><label>Полис</label><input id="policy"></div>
          <div class="col-6"><label>Дата/время</label><input id="dt" type="datetime-local"></div>
          <div class="col-6"><label>Место</label><input id="place"></div>
        </div>
        <div class="hr"></div>
        <h3>Услуги</h3>
        <table class="table">
          <thead><tr><th>Наименование</th><th>Кол-во</th><th>Цена</th><th>Сумма</th><th></th></tr></thead>
          <tbody id="items"></tbody>
        </table>
        <div>
          <button class="btn ghost" id="addPreset">+ Предустановки</button>
          <button class="btn" id="addRow">+ Позиция</button>
          <button class="btn danger" id="clearAll">Очистить</button>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div class="col-6">
            <label>НДС</label>
            <div class="segmented">
              <input type="radio" name="vat" id="vat_inc" checked><label for="vat_inc">вкл.</label>
              <input type="radio" name="vat" id="vat_exc"><label for="vat_exc">нет</label>
            </div>
          </div>
          <div class="col-6">
            <label>Оплата</label>
            <div class="segmented">
              <input type="radio" name="pay" id="pay_cash" checked><label for="pay_cash">Нал</label>
              <input type="radio" name="pay" id="pay_card"><label for="pay_card">Карта</label>
            </div>
          </div>
        </div>
        <div style="margin-top:12px">
          <button class="btn secondary" id="saveDraft">Сохранить</button>
          <button class="btn" id="makeReceipt">Сформировать</button>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>Предпросмотр</h3>
          <div id="preview" class="receipt">
            <div><strong id="p_org"></strong><br><span id="p_addr"></span></div>
            <div class="hr"></div>
            <div>Клиент: <span id="p_cl_name"></span></div>
            <div>Авто: <span id="p_car"></span></div>
            <div>Сумма: <span id="p_total"></span></div>
          </div>
          <button class="btn no-print" id="printBtn" style="margin-top:12px">Печать / PDF</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $=s=>document.querySelector(s);
    const currency=n=>(new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB'})).format(n||0);
    const defaults=[
      {name:'Выезд аварийного комиссара',qty:1,price:2500},
      {name:'Оформление извещения о ДТП',qty:1,price:1500}
    ];
    function addRow(data={name:'',qty:1,price:0}){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td colspan="5"><div class="rowline">
        <input value="${data.name}"><input type="number" value="${data.qty}">
        <input type="number" value="${data.price}"><input disabled>
        <button class="btn ghost">✕</button></div></td>`;
      $('#items').appendChild(tr);
      const [name,qty,price,sum,rm]=tr.querySelectorAll('input,button');
      function recalc(){ sum.value=currency((+qty.value||0)*(+price.value||0)); syncPreview(); }
      qty.oninput=price.oninput=recalc; name.oninput=syncPreview;
      rm.onclick=()=>{tr.remove();syncPreview();}; recalc();
    }
    function collectItems(){
      return [...document.querySelectorAll('.rowline')].map(r=>{
        const i=r.querySelectorAll('input');return{name:i[0].value,qty:+i[1].value,price:+i[2].value};
      }).filter(x=>x.name);
    }
    function calcTotal(items){return items.reduce((s,i)=>s+i.qty*i.price,0);}
    function syncPreview(){
      $('#p_org').textContent=$('#c_org').value;
      $('#p_addr').textContent=$('#c_addr').value;
      $('#p_cl_name').textContent=$('#cl_name').value;
      $('#p_car').textContent=$('#car').value;
      $('#p_total').textContent=currency(calcTotal(collectItems()));
    }
    $('#addRow').onclick=()=>addRow();
    $('#addPreset').onclick=()=>defaults.forEach(addRow);
    $('#clearAll').onclick=()=>{$('#items').innerHTML='';syncPreview();}
    $('#makeReceipt').onclick=syncPreview;
    $('#printBtn').onclick=()=>window.print();
    $('#saveDraft').onclick=()=>{
      const data={fields:['c_org','c_tax','c_phone','c_email','c_addr','cl_name','cl_phone','car','policy','place','dt'].reduce((m,id)=>(m[id]=$('#'+id).value,m),{}),items:collectItems()};
      localStorage.setItem('ac_draft',JSON.stringify(data));alert('Сохранено');
    };
    function loadDraft(){
      const raw=localStorage.getItem('ac_draft');if(!raw)return;
      try{const d=JSON.parse(raw);Object.entries(d.fields).forEach(([k,v])=>{$('#'+k).value=v;});$('#items').innerHTML='';(d.items||[]).forEach(addRow);}catch(e){}
    }
    loadDraft(); addRow(defaults[0]); syncPreview();
  </script>
</body>
</html>
