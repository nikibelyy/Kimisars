<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CRM — Клиенты Из Будущего (Cyberpunk)</title>

<!-- iOS web app meta -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --accent:#8B5CF6;            /* main accent (user provided) */
    --accent-2:#ff2d95;         /* neon secondary */
    --bg:#04030a;               /* dark base */
    --card: rgba(255,255,255,0.02);
    --glass: rgba(255,255,255,0.03);
    --muted: rgba(255,255,255,0.55);
    --neon-glow: 0 12px 40px rgba(139,92,246,0.18), 0 2px 10px rgba(255,45,149,0.06);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(800px 240px at 10% 10%, rgba(139,92,246,0.06), transparent 6%),
    linear-gradient(180deg, rgba(2,0,12,0.6), rgba(0,0,0,0.85)), var(--bg);
    color:#e9e6ee;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }

  .app{
    max-width:980px;margin:18px auto;padding:18px;position:relative;
    -webkit-tap-highlight-color: transparent;
  }

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  .logo{
    display:flex;gap:12px;align-items:center;
  }
  .logo-badge{
    width:54px;height:54px;border-radius:12px;background:
    linear-gradient(135deg,var(--accent), #5b21b6);display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:800;font-family:var(--mono);font-size:18px;box-shadow:var(--neon-glow);
    border:1px solid rgba(255,255,255,0.04);
  }
  .site-title{font-weight:800;letter-spacing:0.6px;color:#fff;font-size:18px}

  /* main stage with 3D rects */
  #stage{
    height:300px;border-radius:14px;position:relative;overflow:hidden;margin-bottom:18px;
    background:
      linear-gradient(120deg, rgba(139,92,246,0.06), rgba(255,45,149,0.02)),
      linear-gradient(180deg, rgba(0,0,0,0.4), rgba(2,2,6,0.6));
    border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 30px 70px rgba(2,2,6,0.7), inset 0 2px 20px rgba(139,92,246,0.02);
    perspective:1200px;
  }

  .floating-objects{position:absolute;inset:0;transform-style:preserve-3d;pointer-events:none}
  .rect{
    width:210px;height:110px;border-radius:12px;position:absolute;left:50%;top:50%;
    transform-origin:center;display:flex;align-items:center;justify-content:center;font-weight:900;
    color:rgba(255,255,255,0.95);backdrop-filter: blur(6px) saturate(150%);
    border:1px solid rgba(255,255,255,0.04);
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 24px 80px rgba(4,3,10,0.7), 0 0 40px rgba(139,92,246,0.07);
    font-family:var(--mono);
    letter-spacing:1px;
    text-transform:uppercase;
    pointer-events:none;
  }
  .rect.small{width:150px;height:74px;border-radius:10px;font-size:13px}
  .rect .label{font-size:16px;color:rgba(255,255,255,0.9);text-shadow:0 2px 10px rgba(139,92,246,0.25)}

  /* cyber-grid overlay */
  #stage::after{
    content:'';position:absolute;inset:0;background-image:
    linear-gradient(transparent 60%, rgba(139,92,246,0.02) 60%),
    linear-gradient(90deg, transparent 60%, rgba(255,45,149,0.01) 60%);
    mix-blend-mode:overlay;pointer-events:none;
  }

  /* panels */
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  .card{
    border-radius:14px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(8px) saturate(140%);
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
  }
  .card .label{font-size:13px;color:var(--muted);margin-bottom:8px}
  .card .value{font-size:24px;font-weight:900;color:var(--accent)}

  .big-card{grid-column:1/-1;padding:20px;border-radius:16px;position:relative}

  /* form */
  form{display:block}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
  input[type="text"], input[type="number"], select{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
    background:rgba(8,6,12,0.55);color:#fff;font-size:15px;outline:none;margin-bottom:12px;
    box-shadow: inset 0 -6px 18px rgba(0,0,0,0.6);
  }
  .row{display:flex;gap:12px}
  .row .col{flex:1}

  .btn{
    background: linear-gradient(90deg,var(--accent), #5b21b6);
    border:none;color:white;padding:12px 14px;border-radius:10px;font-weight:800;cursor:pointer;
    box-shadow: 0 10px 40px rgba(139,92,246,0.26);
  }
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}

  .clients-list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
  .client-row{
    display:flex;justify-content:space-between;gap:8px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));align-items:center;
    transition:transform .25s ease, box-shadow .25s ease;
  }
  .client-row:hover{transform:translateY(-6px);box-shadow:0 18px 50px rgba(139,92,246,0.12)}
  .client-avatar{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:white;font-family:var(--mono)}
  .client-meta{display:flex;flex-direction:column}
  .client-meta .name{font-weight:800}

  /* subtle neon accents for numbers */
  .num-neon{color:var(--accent);font-weight:900;text-shadow:0 6px 26px rgba(139,92,246,0.18)}

  /* small screens */
  @media (max-width:720px){
    .grid{grid-template-columns:1fr}
    #stage{height:220px}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="logo">
      <div class="logo-badge">CP</div>
      <div>
        <div class="site-title">CRM — Cyberpunk 777</div>
      </div>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn" id="exportBtn">Экспорт JSON</button>
    </div>
  </header>

  <!-- main visual (no big textual title) -->
  <div id="stage" aria-hidden="true">
    <div class="floating-objects" id="floatingObjects"></div>
    <canvas id="bgCanvas" width="1200" height="600" style="position:absolute;inset:0;width:100%;height:100%"></canvas>
  </div>

  <div class="grid">
    <div class="card">
      <div class="label">Всего клиентов</div>
      <div class="value num-neon" id="totalClients">0</div>
    </div>

    <div class="card">
      <div class="label">Общая сумма</div>
      <div class="value num-neon" id="totalAmount">₽0</div>
    </div>

    <div class="card">
      <div class="label">Общая зарплата</div>
      <div class="value num-neon" id="totalSalary">₽0</div>
    </div>

    <div class="card">
      <div class="label">Средний процент</div>
      <div class="value num-neon" id="avgPercent">0.0%</div>
    </div>

    <div class="big-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:900">Добавить клиента</div>
      </div>

      <form id="clientForm" onsubmit="return false;">
        <div class="row">
          <div class="col">
            <label>Имя клиента</label>
            <input id="name" type="text" placeholder="Иван Иванов" required />
          </div>
          <div class="col">
            <label>Марка авто</label>
            <input id="brand" type="text" placeholder="Toyota Camry" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Гос. номер</label>
            <input id="plate" type="text" placeholder="A123БВ777" />
          </div>
          <div class="col">
            <label>Сумма (₽)</label>
            <input id="amount" type="number" placeholder="10000" min="0" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Процент (%)</label>
            <input id="percent" type="number" placeholder="10" min="0" step="0.1" value="10" />
          </div>
          <div class="col">
            <label>Вычисленная зарплата (₽)</label>
            <input id="salary" type="number" placeholder="0" readonly />
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
          <button class="btn" id="addBtn">Добавить</button>
          <button class="btn ghost" id="clearBtn">Очистить всё</button>
        </div>
      </form>

      <div class="clients-list" id="clientsList" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   CRM logic (localStorage)
   --------------------------- */
const clientsKey = 'crm_clients_v1_cyber';
let clients = JSON.parse(localStorage.getItem(clientsKey) || '[]');

const $ = id => document.getElementById(id);
const nameI = $('name'), brandI = $('brand'), plateI = $('plate'),
      amountI = $('amount'), percentI = $('percent'), salaryI = $('salary'),
      clientsList = $('clientsList'),
      totalClients = $('totalClients'), totalAmount = $('totalAmount'),
      totalSalary = $('totalSalary'), avgPercent = $('avgPercent'),
      exportBtn = $('exportBtn'), clearBtn = $('clearBtn');

function calcSalary(amount, percent){
  amount = Number(amount)||0;
  percent = Number(percent)||0;
  return +(amount * percent/100).toFixed(2);
}
function num(n){ return (Number(n)||0).toLocaleString('ru-RU'); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function renderClients(){
  clientsList.innerHTML = '';
  let sumAmt = 0, sumSalary = 0, sumPercent = 0;
  clients.forEach((c, i) => {
    sumAmt += Number(c.amount||0);
    sumSalary += Number(c.salary||0);
    sumPercent += Number(c.percent||0);
    const row = document.createElement('div');
    row.className = 'client-row';
    row.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div class="client-avatar">${(c.name||'')[0] || 'C'}</div>
        <div style="display:flex;flex-direction:column">
          <div style="font-weight:900">${escapeHtml(c.name||'—')}</div>
          <div style="color:rgba(255,255,255,0.6);font-size:13px">${escapeHtml(c.brand||'—')} · ${escapeHtml(c.plate||'—')}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:900;color:var(--accent)">${'₽' + num(c.amount)}</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.6)">Зарплата: ₽${num(c.salary)} · ${c.percent}%</div>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button data-i="${i}" class="btn ghost remove" style="padding:6px 8px">Удалить</button>
        </div>
      </div>
    `;
    clientsList.appendChild(row);
  });
  totalClients.textContent = clients.length;
  totalAmount.textContent = '₽' + num(sumAmt);
  totalSalary.textContent = '₽' + num(sumSalary);
  avgPercent.textContent = (clients.length? (sumPercent/clients.length).toFixed(1) : '0.0') + '%';
  document.querySelectorAll('.remove').forEach(b => {
    b.onclick = ()=>{
      const idx = +b.dataset.i;
      clients.splice(idx,1); persist(); renderClients(); feedbackPulse();
    };
  });
}

function persist(){ localStorage.setItem(clientsKey, JSON.stringify(clients)); }

amountI.oninput = percentI.oninput = function(){
  salaryI.value = calcSalary(amountI.value, percentI.value);
};
$('addBtn').onclick = ()=>{
  const name = nameI.value.trim();
  if(!name){ nameI.focus(); return; }
  const item = {
    name, brand: brandI.value.trim(), plate: plateI.value.trim(),
    amount: Number(amountI.value) || 0,
    percent: Number(percentI.value) || 0,
    salary: calcSalary(amountI.value, percentI.value),
    created: Date.now()
  };
  clients.unshift(item);
  persist(); renderClients();
  // clear minimal fields
  nameI.value=''; brandI.value=''; plateI.value=''; amountI.value=''; salaryI.value='';
  celebrateNeon();
};

exportBtn.onclick = ()=>{
  const blob = new Blob([JSON.stringify(clients,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'clients.json'; a.click();
  URL.revokeObjectURL(url);
};

clearBtn.onclick = ()=>{
  if(!confirm('Очистить всех клиентов?')) return;
  clients = []; persist(); renderClients();
};

renderClients();

/* small visual feedback */
function celebrateNeon(){
  const b = document.querySelector('.logo-badge');
  b.style.transition = 'transform 360ms cubic-bezier(.2,.9,.2,1), box-shadow 360ms';
  b.style.transform = 'scale(1.06) rotate(-6deg)';
  b.style.boxShadow = '0 20px 80px rgba(139,92,246,0.35), 0 0 60px rgba(255,45,149,0.15)';
  setTimeout(()=>{ b.style.transform=''; b.style.boxShadow='var(--neon-glow)'; }, 420);
}
function feedbackPulse(){
  const s = document.getElementById('stage');
  s.style.transition = 'box-shadow 260ms'; s.style.boxShadow = '0 40px 120px rgba(139,92,246,0.18)';
  setTimeout(()=> s.style.boxShadow = '0 30px 70px rgba(2,2,6,0.7), inset 0 2px 20px rgba(139,92,246,0.02)', 360);
}

/* ---------------------------
   background orbs + rects (cyberpunk 3D)
   --------------------------- */
const bgCanvas = $('bgCanvas');
const bgCtx = bgCanvas.getContext('2d');
let orbs = [], rects = [];

function initBg(){
  bgCanvas.width = bgCanvas.clientWidth * (window.devicePixelRatio || 1);
  bgCanvas.height = bgCanvas.clientHeight * (window.devicePixelRatio || 1);
  // orbs
  orbs = [];
  for(let i=0;i<6;i++){
    orbs.push({
      x: Math.random()*bgCanvas.width,
      y: Math.random()*bgCanvas.height,
      r: 40 + Math.random()*120,
      vx: (Math.random()-0.5)*0.2,
      vy: (Math.random()-0.5)*0.2,
      alpha: 0.06 + Math.random()*0.22
    });
  }
  // create rect placeholders in DOM
  createRects();
}
function drawBg(){
  requestAnimationFrame(drawBg);
  const W = bgCanvas.width, H = bgCanvas.height;
  bgCtx.clearRect(0,0,W,H);
  // base
  const g = bgCtx.createLinearGradient(0,0,W,H);
  g.addColorStop(0,'rgba(6,4,12,0.9)');
  g.addColorStop(1,'rgba(3,2,8,0.95)');
  bgCtx.fillStyle = g; bgCtx.fillRect(0,0,W,H);
  // orbs
  for(let o of orbs){
    o.x += o.vx; o.y += o.vy;
    if(o.x < -o.r) o.x = W+o.r;
    if(o.x > W+o.r) o.x = -o.r;
    if(o.y < -o.r) o.y = H+o.r;
    if(o.y > H+o.r) o.y = -o.r;
    const rg = bgCtx.createRadialGradient(o.x,o.y,0,o.x,o.y,o.r);
    rg.addColorStop(0, `rgba(139,92,246,${0.12 + o.alpha*0.6})`);
    rg.addColorStop(0.6, `rgba(255,45,149,${0.02 + o.alpha*0.1})`);
    rg.addColorStop(1, 'rgba(0,0,0,0)');
    bgCtx.fillStyle = rg; bgCtx.fillRect(o.x-o.r,o.y-o.r,o.r*2,o.r*2);
  }
}
initBg(); drawBg();
window.addEventListener('resize',()=> setTimeout(initBg,120));

/* rects (DOM) */
function createRects(){
  const container = $('floatingObjects');
  container.innerHTML = ''; rects = [];
  const labels = ['NEON','VIP','ORDER','CHAIN','CORE','NODE'];
  for(let i=0;i<6;i++){
    const d = document.createElement('div'); d.className='rect' + (i%2? ' small':'');
    d.style.left = (8 + Math.random()*84) + '%';
    d.style.top = (12 + Math.random()*72) + '%';
    d.style.opacity = 0.9 - Math.random()*0.3;
    d.style.transform = `translate3d(-50%,-50%,0) rotateX(${8+i*3}deg) rotateY(${i*15}deg)`;
    d.innerHTML = `<div class="label">${labels[i%labels.length]}</div>`;
    container.appendChild(d);
    rects.push({el:d, baseX:parseFloat(d.style.left), baseY:parseFloat(d.style.top), rx:8+i*3, ry:i*15, s:0.8 + Math.random()*1.2});
  }
}

/* parallax by mouse / touch */
let mouseX=0, mouseY=0;
const stageRect = ()=> document.getElementById('stage').getBoundingClientRect();
window.addEventListener('mousemove', (e)=>{
  const r = stageRect();
  mouseX = (e.clientX - (r.left + r.width/2)) / r.width;
  mouseY = (e.clientY - (r.top + r.height/2)) / r.height;
  updateRects();
});
window.addEventListener('touchmove', (e)=>{
  if(!e.touches||!e.touches[0]) return;
  const r = stageRect();
  mouseX = (e.touches[0].clientX - (r.left + r.width/2)) / r.width;
  mouseY = (e.touches[0].clientY - (r.top + r.height/2)) / r.height;
  updateRects();
},{passive:true});
function updateRects(){
  rects.forEach((r,i)=>{
    const tx = r.baseX + mouseX*(8 + i*2);
    const ty = r.baseY + mouseY*(10 - i);
    const rx = r.rx + mouseY * -60;
    const ry = r.ry + mouseX * 120;
    r.el.style.left = tx + '%'; r.el.style.top = ty + '%';
    r.el.style.transform = `translate3d(-50%,-50%,0) rotateX(${rx}deg) rotateY(${ry}deg) scale(${r.s})`;
    r.el.style.boxShadow = `0 30px 80px rgba(4,3,10,0.7), 0 0 ${40 + i*8}px rgba(139,92,246,${0.08 + i*0.06})`;
  });
}

/* flip effect on scroll */
let flipped=false;
window.addEventListener('wheel', (e)=>{
  flipped = !flipped;
  rects.forEach((r,i)=>{
    if(flipped) r.el.style.transform += ' rotateY(180deg)';
    else r.el.style.transform = r.el.style.transform.replace(' rotateY(180deg)','');
  });
});

/* ---------------------------
   PWA: manifest + service worker (created dynamically so single-file)
   --------------------------- */
function createManifestAndSW(){
  // create a tiny SVG icon as data URL
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='100%' height='100%' rx='24' fill='#0b0611'/><g fill='none' stroke='%238B5CF6' stroke-width='6'><rect x='20' y='20' width='152' height='152' rx='18'/></g><text x='96' y='118' font-family='monospace' font-size='64' fill='%23fff' text-anchor='middle'>CP</text></svg>`;
  const svgData = 'data:image/svg+xml;base64,' + btoa(svg);

  const manifest = {
    "name":"CRM — Cyberpunk 777",
    "short_name":"CRM-CP",
    "start_url":".",
    "display":"standalone",
    "background_color":"#04030a",
    "theme_color":"#8B5CF6",
    "icons":[
      {"src":svgData,"sizes":"192x192","type":"image/svg+xml"},
      {"src":svgData,"sizes":"512x512","type":"image/svg+xml"}
    ]
  };
  // add manifest link dynamically
  const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const mURL = URL.createObjectURL(mBlob);
  let l = document.querySelector('link[rel="manifest"]');
  if(!l){ l = document.createElement('link'); l.rel='manifest'; document.head.appendChild(l); }
  l.href = mURL;

  // add apple touch icon
  let aLink = document.querySelector('link[rel="apple-touch-icon"]');
  if(!aLink){ aLink = document.createElement('link'); aLink.rel='apple-touch-icon'; document.head.appendChild(aLink); }
  aLink.href = svgData;

  // create service worker blob
  const swCode = `
    const CACHE = 'crm-cyber-cache-v1';
    const toCache = ['.'];
    self.addEventListener('install', e => {
      self.skipWaiting();
      e.waitUntil(caches.open(CACHE).then(c => c.addAll(toCache)).catch(()=>{}));
    });
    self.addEventListener('activate', e => {
      e.waitUntil(clients.claim());
    });
    self.addEventListener('fetch', e => {
      if(e.request.method !== 'GET') return;
      e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).then(res => {
        try{
          if(res && res.type === 'basic'){
            const copy = res.clone();
            caches.open(CACHE).then(c => c.put(e.request, copy));
          }
        }catch(err){}
        return res;
      }).catch(()=>caches.match('.'))));
    });
  `;
  const swBlob = new Blob([swCode], {type:'application/javascript'});
  const swURL = URL.createObjectURL(swBlob);
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register(swURL).then(reg=>{
      console.log('SW registered', reg);
    }).catch(err=>{
      console.warn('SW failed', err);
    });
  }
}
// create on load
window.addEventListener('load', createManifestAndSW);

/* small: avoid passive touch highlight on mobile */
document.addEventListener('touchstart', ()=>{}, {passive:true});
</script>
</body>
</html>
