<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini CRM — iOS style</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --bg: #f3f4f6;
    --card: rgba(255,255,255,0.7);
    --border: rgba(0,0,0,0.06);
    --text: #0b0c0f;
    --muted: #6b7280;
    --accent: #007aff;           /* iOS blue */
    --good: #34c759;             /* iOS green */
    --bad: #ff3b30;              /* iOS red */
    --warn: #ff9f0a;
    --shadow: 0 8px 24px rgba(0,0,0,0.08);
    --radius: 16px;
    --blur: 16px;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b0c0f;
      --card: rgba(22,23,28,0.6);
      --border: rgba(255,255,255,0.08);
      --text:#f6f7f9;
      --muted:#a9acb2;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
  }
  html,body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text","Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: radial-gradient(1200px 800px at 10% -10%, rgba(0,122,255,0.07), transparent 60%),
                radial-gradient(900px 700px at 110% 10%, rgba(52,199,89,0.08), transparent 55%),
                var(--bg);
    color:var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .container{
    max-width:1100px;
    margin:24px auto;
    padding:0 16px 64px;
  }
  header.app{
    display:flex;
    align-items:center;
    gap:16px;
    margin:12px 0 20px;
  }
  .logo{
    width:48px;height:48px; border-radius:14px;
    backdrop-filter: blur(var(--blur));
    background: var(--card);
    border:1px solid var(--border);
    box-shadow: var(--shadow);
    display:grid; place-items:center;
    font-weight:700; color:var(--accent);
  }
  .title h1{font-size:22px; margin:0;}
  .title .sub{color:var(--muted); font-size:13px;}
  .toolbar{
    margin-left:auto; display:flex; flex-wrap:wrap; gap:10px;
  }
  .btn{
    appearance:none; border:1px solid var(--border); background:var(--card);
    padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow: var(--shadow);
    backdrop-filter: blur(var(--blur));
    display:inline-flex; align-items:center; gap:8px; font-weight:600;
  }
  .btn.primary{ border-color:transparent; background:linear-gradient(180deg, #1d8cff, #0a6bda); color:white; }
  .btn.good{ background:linear-gradient(180deg, #45d86a, #1ea84a); color:white; border-color:transparent;}
  .btn.warn{ background:linear-gradient(180deg, #ffb340, #ff9a0a); color:white; border-color:transparent;}
  .btn:active{ transform: translateY(1px); }

  /* Cards / sections */
  .grid{
    display:grid; grid-template-columns: 1.1fr 1fr; gap:16px;
  }
  @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

  .card{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(var(--blur));
    padding:16px;
  }
  .card h2{font-size:16px; margin:0 0 8px;}
  .split{ display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
  .muted{ color:var(--muted); }

  /* Plan widget */
  .plan{
    display:flex; align-items:center; gap:20px;
  }
  .ring{ width:140px; height:140px; position:relative; }
  .ring svg{transform: rotate(-90deg);}
  .ring .center{
    position:absolute; inset:0; display:grid; place-items:center; text-align:center; font-weight:700;
  }
  .ring .center small{ display:block; color:var(--muted); font-weight:600; }

  .plan-controls{
    display:grid; grid-template-columns: 1fr 1fr; gap:10px; width:100%;
  }
  .input, select{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background: rgba(255,255,255,0.55);
    backdrop-filter: blur(var(--blur)); box-shadow: var(--shadow); color:var(--text);
  }
  @media (prefers-color-scheme: dark){ .input, select{ background: rgba(30,31,36,0.6);} }
  label{ font-size:12px; color:var(--muted); display:block; margin:6px 2px; }

  /* List */
  .list-toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0 12px; }
  table{
    width:100%; border-collapse: collapse; overflow:hidden;
  }
  th, td{
    padding:12px 10px; border-bottom:1px solid var(--border); font-size:14px;
  }
  th{ text-align:left; color:var(--muted); font-weight:700; }
  tbody tr:hover{ background: rgba(0,0,0,0.04); }
  @media (prefers-color-scheme: dark){ tbody tr:hover{ background: rgba(255,255,255,0.03);} }

  .status{ padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; display:inline-block; }
  .s-lead{ background: rgba(0,122,255,0.15); color:#007aff; }
  .s-progress{ background: rgba(255,159,10,0.18); color:#b96a00; }
  .s-won{ background: rgba(52,199,89,0.18); color:#1a7c3a; }
  .s-lost{ background: rgba(255,59,48,0.18); color:#9e1c16; }

  /* Modal */
  dialog{
    border:none; border-radius:20px; padding:0; background:var(--card); box-shadow: 0 40px 120px rgba(0,0,0,0.35);
    width:min(680px, 92vw);
  }
  dialog::backdrop{ backdrop-filter: blur(8px); background: rgba(0,0,0,0.25);}
  .modal-head{ padding:16px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
  .modal-body{ padding:18px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .modal-actions{ padding:16px 18px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid var(--border); }
  @media (max-width:680px){ .modal-body{ grid-template-columns: 1fr; } }

  /* Chips / misc */
  .chip{ font-size:12px; padding:6px 10px; border-radius:999px; background: rgba(0,0,0,0.06); color:var(--muted);}
  .kpi{ display:flex; gap:12px; flex-wrap:wrap; }
  .kpi .card{ flex:1 1 220px; }
  .kpi .value{ font-size:20px; font-weight:800; }
  .right{ margin-left:auto; }
  .link{ color:var(--accent); cursor:pointer; }

  /* Footer */
  footer{ margin-top:24px; color:var(--muted); font-size:12px; text-align:center; }
</style>
</head>
<body>
  <div class="container">
    <header class="app">
      <div class="logo">CRM</div>
      <div class="title">
        <h1>Ваша мини-CRM</h1>
        <div class="sub">Локальное хранение · офлайн · iOS-стиль</div>
      </div>
      <div class="toolbar">
        <button class="btn primary" id="addClientBtn">➕ Добавить клиента</button>
        <button class="btn" id="exportBtn">⬇️ Экспорт</button>
        <button class="btn" id="importBtn">⬆️ Импорт</button>
        <input type="file" id="importFile" accept="application/json" hidden />
      </div>
    </header>

    <section class="grid">
      <!-- PLAN / PROGRESS -->
      <div class="card">
        <h2>План месяца</h2>
        <div class="plan">
          <div class="ring" aria-label="Прогресс плана">
            <svg width="140" height="140">
              <defs>
                <linearGradient id="grad">
                  <stop offset="0%" stop-color="#1d8cff"/>
                  <stop offset="100%" stop-color="#0a6bda"/>
                </linearGradient>
              </defs>
              <circle cx="70" cy="70" r="60" stroke="rgba(0,0,0,0.08)" stroke-width="12" fill="none"/>
              <circle id="ringProgress" cx="70" cy="70" r="60" stroke="url(#grad)" stroke-linecap="round" stroke-width="12" fill="none" stroke-dasharray="0 999"/>
            </svg>
            <div class="center">
              <div id="percent" style="font-size:22px">0%</div>
              <small id="progressText">0 / 0 ₽</small>
            </div>
          </div>
          <div class="plan-controls">
            <div>
              <label>Месяц</label>
              <input class="input" id="monthPicker" type="month"/>
            </div>
            <div>
              <label>План (₽)</label>
              <input class="input" id="planInput" type="number" min="0" step="1000" placeholder="Например, 500000"/>
            </div>
            <div>
              <label>Фильтр по статусу</label>
              <select id="statusFilter">
                <option value="all">Все</option>
                <option value="lead">Лид</option>
                <option value="in_progress">В работе</option>
                <option value="won">Сделка закрыта (Won)</option>
                <option value="lost">Сделка проиграна (Lost)</option>
              </select>
            </div>
            <div>
              <label>Поиск</label>
              <input class="input" id="searchInput" type="search" placeholder="Имя, компания, телефон, e-mail"/>
            </div>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpi">
        <div class="card">
          <div class="muted">Клиентов в базе</div>
          <div class="value" id="kpiClients">0</div>
        </div>
        <div class="card">
          <div class="muted">Сделок закрыто (месяц)</div>
          <div class="value" id="kpiWonCount">0</div>
        </div>
        <div class="card">
          <div class="muted">Выручка (месяц)</div>
          <div class="value" id="kpiWonSum">0 ₽</div>
        </div>
      </div>
    </section>

    <!-- LIST -->
    <section class="card" style="margin-top:16px;">
      <div class="split">
        <h2>Клиенты</h2>
        <div class="right chip" id="currentMonthLabel"></div>
      </div>

      <div class="list-toolbar">
        <span class="muted">Сортировка:</span>
        <button class="btn" data-sort="createdAt">По дате добавления</button>
        <button class="btn" data-sort="name">По имени</button>
        <button class="btn" data-sort="value">По сумме сделки</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>Имя</th>
            <th>Компания</th>
            <th>Контакты</th>
            <th>Сумма</th>
            <th>Статус</th>
            <th>Создан</th>
            <th>Закрыт</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="clientBody"></tbody>
        </table>
      </div>
    </section>

    <footer>© Ваше мини-CRM. Данные хранятся локально в этом браузере.</footer>
  </div>

  <!-- MODAL -->
  <dialog id="clientModal">
    <form id="clientForm" method="dialog">
      <div class="modal-head">
        <h3 id="modalTitle" style="margin:0;font-size:18px;">Новый клиент</h3>
        <div class="chip right" id="idChip">ID</div>
      </div>
      <div class="modal-body">
        <div>
          <label>Имя *</label>
          <input class="input" name="name" required placeholder="Иван Иванов"/>
        </div>
        <div>
          <label>Компания</label>
          <input class="input" name="company" placeholder="ООО Ромашка"/>
        </div>
        <div>
          <label>Телефон</label>
          <input class="input" name="phone" placeholder="+7 900 000-00-00"/>
        </div>
        <div>
          <label>E-mail</label>
          <input class="input" name="email" type="email" placeholder="name@company.ru"/>
        </div>
        <div>
          <label>Сумма сделки (₽)</label>
          <input class="input" name="dealValue" type="number" min="0" step="100" placeholder="100000"/>
        </div>
        <div>
          <label>Статус</label>
          <select name="status">
            <option value="lead">Лид</option>
            <option value="in_progress">В работе</option>
            <option value="won">Закрыта (Won)</option>
            <option value="lost">Проиграна (Lost)</option>
          </select>
        </div>
        <div>
          <label>Дата создания</label>
          <input class="input" name="createdAt" type="date"/>
        </div>
        <div>
          <label>Дата закрытия (если есть)</label>
          <input class="input" name="closedAt" type="date"/>
        </div>
        <input type="hidden" name="id"/>
      </div>
      <div class="modal-actions">
        <button class="btn" value="cancel" type="button" id="cancelBtn">Отмена</button>
        <button class="btn warn" type="button" id="deleteBtn">Удалить</button>
        <button class="btn good" id="saveBtn">Сохранить</button>
      </div>
    </form>
  </dialog>

<script>
/* ===== Utilities ===== */
const $ = (q, root=document) => root.querySelector(q);
const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
const fmtMoney = n => (Number(n||0)).toLocaleString('ru-RU') + ' ₽';
const monthKey = (d) => {
  const dt = (d ? new Date(d) : new Date());
  return dt.toISOString().slice(0,7); // YYYY-MM
};
const toISODate = (d) => d ? new Date(d).toISOString().slice(0,10) : '';

/* ===== Storage ===== */
const store = {
  readClients(){ try{ return JSON.parse(localStorage.getItem('crm_clients')||'[]'); }catch{ return []; } },
  writeClients(list){ localStorage.setItem('crm_clients', JSON.stringify(list)); },
  readPlanMap(){ try{ return JSON.parse(localStorage.getItem('crm_plan_by_month')||'{}'); }catch{ return {}; } },
  writePlanMap(map){ localStorage.setItem('crm_plan_by_month', JSON.stringify(map)); },
  export(){
    const data = {
      version:1,
      exportedAt: new Date().toISOString(),
      clients: this.readClients(),
      plans: this.readPlanMap(),
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `crm-backup-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  },
  async import(file){
    const text = await file.text();
    const data = JSON.parse(text);
    if(!data || !Array.isArray(data.clients)) throw new Error('Неверный формат файла');
    localStorage.setItem('crm_clients', JSON.stringify(data.clients));
    localStorage.setItem('crm_plan_by_month', JSON.stringify(data.plans || {}));
  }
};

/* ===== State ===== */
let clients = store.readClients();
let plans = store.readPlanMap();
let state = {
  sortBy: 'createdAt', // name | value
  month: monthKey(),
  filter: 'all',
  search: ''
};

/* ===== UI: Plan & KPIs ===== */
function setMonthInputs(){
  const mp = $('#monthPicker');
  mp.value = state.month;
  $('#currentMonthLabel').textContent = new Date(state.month + '-01').toLocaleDateString('ru-RU', {month:'long', year:'numeric'});
  $('#planInput').value = plans[state.month] || '';
}
function computeMetrics(){
  const currentMonth = state.month;
  const wonThisMonth = clients.filter(c => c.status==='won' && c.closedAt && monthKey(c.closedAt)===currentMonth);
  const wonSum = wonThisMonth.reduce((s,c)=> s + Number(c.dealValue||0), 0);
  const plan = Number(plans[currentMonth]||0);
  const pct = plan>0 ? Math.min(100, Math.round(wonSum/plan*100)) : 0;
  return {wonThisMonth, wonSum, plan, pct};
}
function drawRing(pct){
  const r = 60, circ = 2*Math.PI*r;
  const dash = (pct/100)*circ;
  const rest = Math.max(0, circ - dash);
  const el = $('#ringProgress');
  el.setAttribute('stroke-dasharray', `${dash} ${rest}`);
  $('#percent').textContent = `${pct}%`;
}
function refreshKPIs(){
  const {wonThisMonth, wonSum, plan, pct} = computeMetrics();
  $('#progressText').textContent = `${fmtMoney(wonSum)} / ${fmtMoney(plan)}`;
  $('#kpiWonCount').textContent = wonThisMonth.length;
  $('#kpiWonSum').textContent = fmtMoney(wonSum);
  $('#kpiClients').textContent = clients.length;
  drawRing(pct);
}

/* ===== UI: List ===== */
function renderList(){
  const body = $('#clientBody');
  body.innerHTML = '';
  const term = state.search.trim().toLowerCase();

  let filtered = clients.filter(c=>{
    const inMonth = !c.closedAt || state.filter!=='won' && state.filter!=='lost'
      ? true
      : monthKey(c.closedAt)===state.month;

    const byStatus = state.filter==='all' ? true : (
      state.filter==='in_progress' ? c.status==='in_progress' :
      state.filter==='lead' ? c.status==='lead' :
      state.filter==='won' ? c.status==='won' :
      state.filter==='lost' ? c.status==='lost' : true
    );

    const hay = `${c.name} ${c.company||''} ${c.phone||''} ${c.email||''}`.toLowerCase();
    const bySearch = !term || hay.includes(term);

    return byStatus && bySearch && inMonth;
  });

  filtered.sort((a,b)=>{
    if(state.sortBy==='name') return (a.name||'').localeCompare(b.name||'');
    if(state.sortBy==='value') return (Number(b.dealValue||0) - Number(a.dealValue||0));
    return new Date(b.createdAt||0) - new Date(a.createdAt||0);
  });

  for(const c of filtered){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(c.name)}</td>
      <td>${escapeHtml(c.company||'')}</td>
      <td>
        ${c.phone ? `<div>📞 ${escapeHtml(c.phone)}</div>`:''}
        ${c.email ? `<div>✉️ ${escapeHtml(c.email)}</div>`:''}
      </td>
      <td>${c.dealValue? fmtMoney(c.dealValue): '—'}</td>
      <td>${statusPill(c.status)}</td>
      <td>${c.createdAt? new Date(c.createdAt).toLocaleDateString('ru-RU'): '—'}</td>
      <td>${c.closedAt? new Date(c.closedAt).toLocaleDateString('ru-RU'): '—'}</td>
      <td style="text-align:right; white-space:nowrap;">
        <button class="btn" data-edit="${c.id}">✏️</button>
        <button class="btn" data-win="${c.id}">✅</button>
        <button class="btn" data-lose="${c.id}">❌</button>
      </td>
    `;
    body.appendChild(tr);
  }

  // bind row buttons
  $$('#clientBody [data-edit]').forEach(btn=>btn.addEventListener('click', e=>openModal(e.target.dataset.edit)));
  $$('#clientBody [data-win]').forEach(btn=>btn.addEventListener('click', e=>quickClose(e.target.dataset.win, 'won')));
  $$('#clientBody [data-lose]').forEach(btn=>btn.addEventListener('click', e=>quickClose(e.target.dataset.lose, 'lost')));
}

function statusPill(status){
  const map = {
    'lead':'s-lead', 'in_progress':'s-progress', 'won':'s-won', 'lost':'s-lost'
  };
  const label = {
    'lead':'Лид', 'in_progress':'В работе', 'won':'Закрыта', 'lost':'Проиграна'
  };
  return `<span class="status ${map[status]||''}">${label[status]||status}</span>`;
}

function escapeHtml(s=''){
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ===== Modal add/edit ===== */
const modal = $('#clientModal');
const form  = $('#clientForm');

function openModal(id=null){
  $('#modalTitle').textContent = id ? 'Редактирование клиента' : 'Новый клиент';
  $('#deleteBtn').style.display = id ? '' : 'none';
  $('#idChip').textContent = id ? `ID ${id}` : 'Новый';
  form.reset();
  const todayISO = toISODate(new Date());
  form.elements.createdAt.value = todayISO;

  if(id){
    const c = clients.find(x=>x.id===id);
    if(!c) return;
    for(const k of ['name','company','phone','email','dealValue','status','createdAt','closedAt','id']){
      if(form.elements[k]) form.elements[k].value = c[k] ?? '';
    }
  }else{
    form.elements.status.value = 'lead';
    form.elements.id.value = crypto.randomUUID();
  }
  modal.showModal();
}

function saveClient(){
  const data = Object.fromEntries(new FormData(form).entries());
  data.dealValue = Number(data.dealValue||0);
  // normalize dates
  if(!data.createdAt) data.createdAt = toISODate(new Date());
  if(data.closedAt==='') data.closedAt = null;

  const idx = clients.findIndex(c=>c.id===data.id);
  if(idx>=0){ clients[idx] = {...clients[idx], ...data}; }
  else { clients.push({ ...data }); }

  store.writeClients(clients);
  modal.close();
  redraw();
}

function deleteClient(){
  const id = form.elements.id.value;
  clients = clients.filter(c=>c.id!==id);
  store.writeClients(clients);
  modal.close();
  redraw();
}

function quickClose(id, status){ // win/lose with today date
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  c.status = status;
  c.closedAt = toISODate(new Date());
  if(!c.dealValue) c.dealValue = 0;
  store.writeClients(clients);
  redraw();
}

/* ===== Events ===== */
$('#addClientBtn').addEventListener('click', ()=>openModal());
$('#saveBtn').addEventListener('click', e=>{ e.preventDefault(); saveClient(); });
$('#deleteBtn').addEventListener('click', e=>{ e.preventDefault(); if(confirm('Удалить клиента?')) deleteClient(); });
$('#cancelBtn').addEventListener('click', ()=>modal.close());

$('#planInput').addEventListener('change', e=>{
  plans[state.month] = Math.max(0, Number(e.target.value||0));
  store.writePlanMap(plans);
  refreshKPIs();
});
$('#monthPicker').addEventListener('change', e=>{
  state.month = e.target.value || monthKey();
  setMonthInputs();
  refreshKPIs();
  renderList();
});
$('#statusFilter').addEventListener('change', e=>{
  state.filter = e.target.value;
  renderList();
});
$('#searchInput').addEventListener('input', e=>{
  state.search = e.target.value;
  renderList();
});
$$('.list-toolbar .btn').forEach(b=>b.addEventListener('click', ()=>{
  state.sortBy = b.dataset.sort;
  renderList();
}));

$('#exportBtn').addEventListener('click', ()=>store.export());
$('#importBtn').addEventListener('click', ()=>$('#importFile').click());
$('#importFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  try{
    await store.import(file);
    clients = store.readClients();
    plans = store.readPlanMap();
    redraw();
    alert('Импорт завершён');
  }catch(err){
    alert('Ошибка импорта: ' + err.message);
  }finally{
    e.target.value = '';
  }
});

/* ===== Initial seed (optional) ===== */
function ensureSeed(){
  if(clients.length===0){
    const id1 = crypto.randomUUID(), id2 = crypto.randomUUID(), id3 = crypto.randomUUID();
    const today = new Date();
    const iso = toISODate(today);
    const prev = new Date(today.getFullYear(), today.getMonth(), Math.max(1, today.getDate()-5));
    clients = [
      {id:id1, name:'Алексей Н.', company:'ООО Альфа', phone:'+7 912 111-22-33', email:'alex@alfa.ru', dealValue:150000, status:'in_progress', createdAt:iso, closedAt:null},
      {id:id2, name:'Мария К.', company:'ИП Цветы', phone:'+7 995 333-22-11', email:'maria@flowers.ru', dealValue:90000, status:'won', createdAt:toISODate(prev), closedAt:iso},
      {id:id3, name:'ООО Вектор', company:'', phone:'', email:'', dealValue:0, status:'lead', createdAt:iso, closedAt:null}
    ];
    store.writeClients(clients);
    plans[monthKey()] = 300000;
    store.writePlanMap(plans);
  }
}

/* ===== Redraw ===== */
function redraw(){
  setMonthInputs();
  refreshKPIs();
  renderList();
}

/* ===== Boot ===== */
(function boot(){
  ensureSeed();
  state.month = monthKey();
  setMonthInputs();
  redraw();
})();
</script>
</body>
</html>
