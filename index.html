<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Яндекс ДТП</title>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <!-- Подключение Яндекс.Карт -->
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=3de168ba-04ed-42f5-bb4e-6abff9b3f317" type="text/javascript"></script>
    <!-- Подключение скрипта с логикой карты -->
    <script src="traffic_provider.js" type="text/javascript"></script>
</head>
<body>
    <div id="map"></div>
<script>
ymaps.ready(() => {
  const map = new ymaps.Map("map", { center: [51.7039, 39.1812], zoom: 13 });
  const traffic = new ymaps.traffic.provider.Actual({}, { infoLayerShown: true });
  traffic.setMap(map);

  // проверяем события каждые 30 сек
  setInterval(() => {
    const provider = traffic;
    const state = provider.state;
    if (!state) return;

    // если в объекте state есть события
    const events = state.get('events');
    if (!events || !events.length) return;

    events.forEach(e => {
      if (e.type === 'ДТП') {
        fetch('https://80.93.61.59/incident', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            location: e.address || 'Неизвестный адрес',
            type: e.type,
            mapLink: `https://yandex.ru/maps/probki/?ll=${e.point[1]},${e.point[0]}&z=16&l=trf%2Ctrfe&trf=info`
          })
        }).catch(err => console.error('Ошибка POST:', err));
      }
    });
  }, 30000);
});
</script>
</body>
</html>
